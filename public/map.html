<html>
    <head>
        <!-- <title>VATSIM traffic</title> -->
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
        <style>
            body {
              margin: 0;
              padding: 0;
            }
      
            #map {
              position: absolute;
              top: 0;
              bottom: 0;
              width: 100%;
            }

            .mapboxgl-popup {
            max-width: 200px;
            }
          </style>
    </head>
    <body>
        <div id='map'></div>
        <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
        <!-- Load the `mapbox-gl-geocoder` plugin. -->
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css">
        
        <!-- Promise polyfill script is required -->
        <!-- to use Mapbox GL Geocoder in IE 11. -->
        <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
        <script>
        const mapCenter = [134.9, -28.2];
        const mapZoom = 3.5;
        const styleLight = 'mapbox://styles/cycloptivity/ckrai7rg601cw18p5zu4ntq27';
        const styleDark = 'mapbox://styles/cycloptivity/ckrsmmn0623yb17pew9y59lao';
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3ljbG9wdGl2aXR5IiwiYSI6ImNqcDY0NnZnYzBmYjYzd284dzZudmdvZmUifQ.RyR4jd1HRggrbeZRvkv0xg';

        var map = new mapboxgl.Map({
                container: 'map', // container ID
                style: styleLight, // style URL
                center: mapCenter, // starting position [lng, lat]
                zoom:  mapZoom // starting zoom
        });

        // Light / Dark switch
        function findGetParameter(parameterName) {
            var result = null,
                tmp = [];
            location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
            return result;
        }      
        var theme = findGetParameter('theme');
        if(theme == 'dark'){
            map.setStyle(styleDark);
        }
             
        // //options.localGeocoder Function? A function accepting the query string which performs local geocoding to supplement results from the Mapbox Geocoding API. Expected to return an Array of GeoJSON Features in the Carmen GeoJSON format.
        // function forwardGeocoder(query) {
        //     // var response = await fetch(`${window.location.protocol}//${window.location.hostname}:${window.location.port}/v1/pilots`);
        //     // var json = await response.json();
        //     var xmlhttp = new XMLHttpRequest();
        //     xmlhttp.onreadystatechange = function() {
        //     if (this.readyState == 4 && this.status == 200) {
        //         var json = JSON.parse(this.responseText);
        //                     // console.log(json.features.length)
        //             var matchingFeatures = [];
        //             for (var i = 0; i < json.features.length; i++) {
        //                 var feature = json.features[i];
        //                 // Handle queries with different capitalization
        //                 // than the source data by calling toLowerCase().
        //                 if (
        //                 feature.properties.pilot.callsign
        //                 .toLowerCase()
        //                 .search(query.toLowerCase()) !== -1
        //                 ) {
        //                 // Add a tree emoji as a prefix for custom
        //                 // data results using carmen geojson format:
        //                 // https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
        //                 feature['place_name'] = 'ðŸŒ² ' + feature.properties.pilot.callsign;
        //                 feature['center'] = feature.geometry.coordinates;
        //                 matchingFeatures.push(feature);
        //                 }
        //             }
        //             console.log(matchingFeatures)
        //             return matchingFeatures;
        //         }
        //     };
        //     xmlhttp.open("GET", `${window.location.protocol}//${window.location.hostname}:${window.location.port}/v1/pilots`, false);
        //     xmlhttp.send();
        // }

        // // Add the search control to the map.
        // map.addControl(
        // new MapboxGeocoder({
        //     accessToken: mapboxgl.accessToken,
        //     mapboxgl: mapboxgl,
        //     localGeocoder: forwardGeocoder,
        //     localGeocoderOnly: true,
        //     zoom: 14,
        //     placeholder: 'Find aircraft'
        // })
        // );


        // async function getATCSectors() {
        //     try{
        //         var response = await fetch(`${window.location.protocol}//${window.location.hostname}:${window.location.port}/v1/atc/sectors`);
        //         var json = await response.json();
        //         map.addSource('sectors', {
        //                     'type': 'geojson',
        //                     'data': json
        //                 });
        //         // Add a new layer to visualize the polygon.
        //         map.addLayer({
        //         'id': 'sectors',
        //         'type': 'fill',
        //         'source': 'sectors', // reference the data source
        //         'layout': {},
        //         'paint': {
        //         'fill-color': '#0080ff', // blue color fill
        //         'fill-opacity': 0.1
        //         }
        //         });
        //         // Add a black outline around the polygon.
        //         map.addLayer({
        //         'id': 'outline',
        //         'type': 'line',
        //         'source': 'sectors',
        //         'layout': {},
        //         'paint': {
        //         'line-color': '#000',
        //         'line-width': 1
        //         }
        //         });
        //         // // Add sector labels
        //         // json.features.forEach(function(sector){
        //         //     console.log(sector)
        //         //     var marker = new mapboxgl.Marker()
        //         //     .setLngLat(turf.center({geojson: sector}))
        //         //     .addTo(map);
        //         // });
                
        //     }catch(err){
        //         throw Error(err);
        //     }
        // };

        // var refresh = setInterval(setPilotMarkers, 1000);
        // var drawn = false;

        async function setPilotMarkers () {
            console.log(`setPilotMarkers`);
            var response = await fetch(`${window.location.protocol}//${window.location.hostname}:${window.location.port}/v1/pilots`);
            var json = await response.json();
            try{
                // Marker approach
                for (const marker of json.features) {
                    console.log(marker);
                    // Create popup for each Marker
                    const popup = new mapboxgl.Popup({ offset: 25 }).setText(
                    `Callsign: ${marker.properties.pilot.callsign} 
                    Pilot: ${marker.properties.pilot.name}`
                    );
                    // Regex callsigns
                    // Anything using a VH callsign or three leters get GA
                    const re = new RegExp(/^VH-[A-Z]{3}$|^VH[A-Z]{3}$|^[A-Z]{3}$/);
                    const gaIcon = re.test(marker.properties.pilot.callsign);
                    console.log(`gaIcon re ${gaIcon}`);
                    console.log(marker.properties.pilot.callsign)
                    // Create a DOM element for each marker.
                    const el = document.createElement('div');
                    // const width = 20;
                    // const height = 20;
                    el.className = 'marker';
                    if(gaIcon == true){
                        el.style.width = `17px`;
                        el.style.height = `17px`;
                        if(theme=="dark"){
                            el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/flaticon.com/ga-dark.png)`;
                        }else{
                            el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/flaticon.com/ga-light.png)`;
                        }
                    }else{
                        el.style.width = `20px`;
                        el.style.height = `20px`;
                        if(theme=="dark"){
                            el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/fontawesome/jet-dark.png)`;
                        }else{
                            el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/fontawesome/jet-light.png)`;
                        }
                    }

                    el.style.backgroundSize = '100%';
                    el.addEventListener('click', () => {
                    window.alert(marker.properties.message);
                    });
                    
                    // Add markers to the map.
                    new mapboxgl.Marker(el)
                    .setLngLat(marker.geometry.coordinates)
                    .setPopup(popup)
                    // Icon sets are rotated 45
                    .setRotation(marker.properties.pilot.heading - 45)
                    .addTo(map);

                    // Layer approach

                    // Add a symbol layer
                    if(theme=="dark"){
                        var mapLayer = map.getLayer('aircraft');

                        if(typeof mapLayer !== 'undefined') {
                        // Remove map layer & source.
                        map.removeLayer('aircraft').removeSource('aircraft');
                        }

                        map.addSource('aircraft', {
                            'type': 'geojson',
                            'attribution': '<a href="https://github.com/Kahn/vatsim-map">vatsim-map</a>',
                            'data': json
                        });
                        map.addLayer({
                        'id': 'aircraft',
                        'type': 'symbol',
                        'source': 'aircraft',
                        'layout': {
                            // 'icon-image': 'custom-marker',
                            // 'icon-size': 0.08,
                            // 'icon-rotate': [ 'get', 'heading', ['object', ['get', 'pilot']]],
                            // 'icon-allow-overlap': true,
                            // 'icon-ignore-placement': true,
                            'text-field': ['format', ['get', 'callsign', ['object', ['get', 'pilot']]], { 'text-color': '#FFF'}],
                            'text-font': [
                                'Open Sans Semibold',
                                'Arial Unicode MS Bold'
                            ],
                            'text-offset': [1, 1],
                            // 'text-anchor': 'bottom',
                            'text-variable-anchor': ["top", "bottom", "left"],
                            'text-allow-overlap': true,
                            'text-ignore-placement': true
                        }
                        });
                    }else{
                        var mapLayer = map.getLayer('aircraft');

                        if(typeof mapLayer !== 'undefined') {
                        // Remove map layer & source.
                        map.removeLayer('aircraft').removeSource('aircraft');
                        }

                        map.addSource('aircraft', {
                            'type': 'geojson',
                            'attribution': '<a href="https://github.com/Kahn/vatsim-map">vatsim-map</a>',
                            'data': json
                        });

                        map.addLayer({
                        'id': 'aircraft',
                        'type': 'symbol',
                        'source': 'aircraft',
                        'layout': {
                            // 'icon-image': 'custom-marker',
                            // 'icon-size': 0.08,
                            // 'icon-rotate': [ 'get', 'heading', ['object', ['get', 'pilot']]],
                            // 'icon-allow-overlap': true,
                            // 'icon-ignore-placement': true,
                            'text-field': ['format', ['get', 'callsign', ['object', ['get', 'pilot']]], { 'text-color': '#000'}],
                            'text-font': [
                                'Open Sans Semibold',
                                'Arial Unicode MS Bold'
                            ],
                            'text-offset': [1, 1],
                            // 'text-anchor': 'bottom',
                            'text-variable-anchor': ["top", "bottom", "left"],
                            'text-allow-overlap': true,
                            'text-ignore-placement': true
                        }
                        });
                    }

                }
            }catch(err){
                console.log(err)
            }
        };

        async function setPilotsLayer () {
            var response = await fetch(`${window.location.protocol}//${window.location.hostname}:${window.location.port}/v1/pilots`);
            var json = await response.json();
            if(drawn == false){
                try{
                    // Layer approach
                    // map.addSource('aircraft', {
                    //     'type': 'geojson',
                    //     'attribution': '<a href="https://github.com/Kahn/vatsim-map">vatsim-map</a>',
                    //     'data': json
                    // });
                    // // Add a symbol layer
                    // map.addLayer({
                    // 'id': 'aircraft',
                    // 'type': 'symbol',
                    // 'source': 'aircraft',
                    // 'layout': {
                    //     'icon-image': 'custom-marker',
                    //     'icon-size': 0.08,
                    //     'icon-rotate': [ 'get', 'heading', ['object', ['get', 'pilot']]],
                    //     'icon-allow-overlap': true,
                    //     'icon-ignore-placement': true,
                    //     'text-field': ['format', ['get', 'callsign', ['object', ['get', 'pilot']]], { 'text-color': '#000000'}],
                    //     'text-font': [
                    //         'Open Sans Semibold',
                    //         'Arial Unicode MS Bold'
                    //     ],
                    //     'text-offset': [1, 1],
                    //     // 'text-anchor': 'bottom',
                    //     'text-variable-anchor': ["top", "bottom", "left"],
                    //     'text-allow-overlap': true,
                    //     'text-ignore-placement': true
                    // }
                    // });

                    // Marker approach
                    for (const marker of json.features) {
                        // Regex callsigns
                        // Anything using a VH callsign or three leters get GA
                        const re = new RegExp('VH-[A-Z]{3}|VH[A-Z]{3}|[A-Z]{3}')
                        const gaIcon = re.test(marker.callsign);
                        console.log(`gaIcon re ${gaIcon}`);
                        // Create a DOM element for each marker.
                        const el = document.createElement('div');
                        const width = 20;
                        const height = 20;
                        el.className = 'marker';
                        if(gaIcon){
                            if(theme=="dark"){
                                el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/flaticon.com/ga-dark.png)`;
                            }else{
                                el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/flaticon.com/ga-light.png)`;
                            }
                        }else{
                            if(theme=="dark"){
                                el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/fontawesome/jet-dark.png)`;
                            }else{
                                el.style.backgroundImage = `url(${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/fontawesome/jet-light.png)`;
                            }
                        }
                        el.style.width = `${width}px`;
                        el.style.height = `${height}px`;
                        el.style.backgroundSize = '100%';
                        
                        el.addEventListener('click', () => {
                        window.alert(marker.properties.message);
                        });
                        
                        // Add markers to the map.
                        new mapboxgl.Marker(el)
                        .setLngLat(marker.geometry.coordinates)
                        .addTo(map);
                    }
                    drawn = true;
                }catch(err){
                    console.log(err)
                }
            }else{
                try{
                    // map.getSource('aircraft').setData(json);
                }catch(err){
                    console.log(err)
                }
            }
        };

        map.on('load', function () {
            console.log(`map.on load`);
            // Add an image to use as a custom marker
            // map.loadImage(
            // `${window.location.protocol}//${window.location.hostname}:${window.location.port}/static/fontawesome/jet-light.png`,
            // function (error, image) {
            //     if (error) throw error;
            //     map.addImage('custom-marker', image);
            // }
            // );

            // getATCSectors();
            setPilotMarkers();
        });
       
        </script>
    </body>
</html>