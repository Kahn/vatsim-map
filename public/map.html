<html>
    <head>
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
        <style>
            body {
              margin: 0;
              padding: 0;
            }
      
            #map {
              position: absolute;
              top: 0;
              bottom: 0;
              width: 100%;
            }

            .marker {
                background-image: url('/static/aircraft.png');
                background-size: cover;
                width: 5px;
                height: 5px;
                border-radius: 0%;
                cursor: pointer;
            }
          </style>
    </head>
    <body>
        <div id='map'></div>
        <!-- Load the `mapbox-gl-geocoder` plugin. -->
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css">
        
        <!-- Promise polyfill script is required -->
        <!-- to use Mapbox GL Geocoder in IE 11. -->
        <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
        <script>
        const mapCenter = [134.9, -28.2];
        const mapZoom = 3.2;
        const styleLight = 'mapbox://styles/cycloptivity/ckrai7rg601cw18p5zu4ntq27';
        const styleDark = 'mapbox://styles/cycloptivity/ckrsmmn0623yb17pew9y59lao';
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3ljbG9wdGl2aXR5IiwiYSI6ImNqcDY0NnZnYzBmYjYzd284dzZudmdvZmUifQ.RyR4jd1HRggrbeZRvkv0xg';

        var map = new mapboxgl.Map({
                container: 'map', // container ID
                style: styleLight, // style URL
                center: mapCenter, // starting position [lng, lat]
                zoom:  mapZoom // starting zoom
        });

        // Light / Dark switch
        function findGetParameter(parameterName) {
            var result = null,
                tmp = [];
            location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
            return result;
        }        
        var theme = findGetParameter('theme');
        if(theme == 'dark'){
            map.setStyle(styleDark);
        }
             
        map.on('load', function () {
            // Add an image to use as a custom marker
            map.loadImage(
            `http://${window.location.hostname}:${window.location.port}/static/aircraft.png`,
            function (error, image) {
                if (error) throw error;
                map.addImage('custom-marker', image);
            }
            );
        });

        //options.localGeocoder Function? A function accepting the query string which performs local geocoding to supplement results from the Mapbox Geocoding API. Expected to return an Array of GeoJSON Features in the Carmen GeoJSON format.
        function forwardGeocoder(query) {
            // var response = await fetch(`http://${window.location.hostname}:${window.location.port}/v1/pilots`);
            // var json = await response.json();
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var json = JSON.parse(this.responseText);
                            // console.log(json.features.length)
                    var matchingFeatures = [];
                    for (var i = 0; i < json.features.length; i++) {
                        var feature = json.features[i];
                        // Handle queries with different capitalization
                        // than the source data by calling toLowerCase().
                        if (
                        feature.properties.pilot.callsign
                        .toLowerCase()
                        .search(query.toLowerCase()) !== -1
                        ) {
                        // Add a tree emoji as a prefix for custom
                        // data results using carmen geojson format:
                        // https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                        feature['place_name'] = 'ðŸŒ² ' + feature.properties.pilot.callsign;
                        feature['center'] = feature.geometry.coordinates;
                        matchingFeatures.push(feature);
                        }
                    }
                    console.log(matchingFeatures)
                    return matchingFeatures;
                }
            };
            xmlhttp.open("GET", `http://${window.location.hostname}:${window.location.port}/v1/pilots`, false);
            xmlhttp.send();
        }

        // Add the search control to the map.
        map.addControl(
        new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            localGeocoder: forwardGeocoder,
            localGeocoderOnly: true,
            zoom: 14,
            placeholder: 'Find aircraft'
        })
        );


        var refresh = setInterval(setPilotsLayer, 15000);
        var drawn = false;
        async function setPilotsLayer () {
            var response = await fetch(`http://${window.location.hostname}:${window.location.port}/v1/pilots`);
            var json = await response.json();
            if(drawn == false){
                try{
                    map.addSource('points', {
                        'type': 'geojson',
                        'attribution': '<a href="https://github.com/Kahn/vatsim-map">vatsim-map</a>',
                        'data': json
                    });
                    // Add a symbol layer
                    map.addLayer({
                    'id': 'points',
                    'type': 'symbol',
                    'source': 'points',
                    'layout': {
                        'icon-image': 'custom-marker',
                        'icon-size': 0.1,
                        'icon-rotate': [ 'get', 'heading', ['object', ['get', 'pilot']]],
                        'icon-allow-overlap': false,
                        'icon-ignore-placement': false,
                        // get the title name from the source's "title" property
                        'text-field': [
                            'format', ['get', 'callsign', ['object', ['get', 'pilot']]], { 'text-color': '#000000'}],
                        'text-font': [
                            'Open Sans Semibold',
                            'Arial Unicode MS Bold'
                        ],
                        'text-offset': [1, 1],
                        // 'text-anchor': 'bottom',
                        'text-variable-anchor': ["top", "bottom", "left"],
                        'text-allow-overlap': false,
                        'text-ignore-placement': false
                    }
                    });
                    drawn = true;
                }catch(err){
                    console.log(err)
                }
            }else{
                try{
                    map.getSource('points').setData(json);
                }catch(err){
                    console.log(err)
                }
            }
        };
        setPilotsLayer();
       
        </script>
    </body>
</html>